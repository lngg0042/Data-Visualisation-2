{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 700,
  "height": 450,
  "title": {
    "text": "Value of Fixed Assets by State (% of Total)",
    "fontSize": 20,
    "anchor": "middle",
    "subtitle": "Selangor & KL consistently dominate, smaller eastern states contribute less than 2%"
  },
  "data": {
    "url": "https://raw.githubusercontent.com/lngg0042/Data-Visualisation-2/refs/heads/main/Principal%20Statistics%20of%20Transportation%20and%20Storage%20Services%20by%20State%20dataset.csv"
  },
  "params": [
    {
      "name": "year_selection",
      "value": 2015,
      "bind": {
        "input": "select",
        "options": [2010, 2014, 2015, 2017],
        "name": "Year: "
      }
    }
  ],
  "transform": [
    {"filter": "datum.Year == year_selection"},
    {
      "joinaggregate": [
        {"op": "sum", "field": "Value of fixed assets", "as": "total_fixed_assets"}
      ],
      "groupby": ["Year"]
    },
    {
      "calculate": "datum['Value of fixed assets'] / datum.total_fixed_assets * 100",
      "as": "percentage"
    },
    {
      "window": [{"op": "rank", "field": "percentage", "as": "rank"}],
      "sort": [{"field": "percentage", "order": "descending"}]
    },
    {
      "calculate": "datum.rank <= 3 ? 'Top 3' : 'Other'",
      "as": "highlight"
    }
  ],
  "layer": [
    {
      "mark": {"type": "bar", "tooltip": true},
      "encoding": {
        "x": {
          "field": "State",
          "type": "nominal",
          "axis": {"title": "State", "labelAngle": -45},
          "sort": "-y"
        },
        "y": {
          "field": "percentage",
          "type": "quantitative",
          "axis": {"title": "Percentage of Total Value of Fixed Assets (%)"},
          "format": ".1f"
        },
        "color": {
          "field": "highlight",
          "type": "nominal",
          "scale": {"domain": ["Top 3", "Other"], "range": ["#00468b", "#a8dadc"]},
          "legend": null
        },
        "tooltip": [
          {"field": "State", "type": "nominal", "title": "State"},
          {"field": "Year", "type": "ordinal", "title": "Year"},
          {"field": "percentage", "type": "quantitative", "title": "Percentage", "format": ".2f"},
          {"field": "Value of fixed assets", "type": "quantitative", "title": "Value of Fixed Assets", "format": ","}
        ]
      }
    },
    {
      "mark": {
        "type": "text",
        "align": "center",
        "baseline": "bottom",
        "dy": -3,
        "fontSize": 11
      },
      "encoding": {
        "x": {"field": "State", "type": "nominal"},
        "y": {"field": "percentage", "type": "quantitative"},
        "text": {"field": "percentage", "type": "quantitative", "format": ".1f"},
        "color": {
          "condition": {"test": "datum.rank <= 3", "value": "#00468b"},
          "value": "black"
        }
      }
    },
    {
      "transform": [
        {
          "aggregate": [{"op": "mean", "field": "percentage", "as": "avg_percentage"}]
        },
        {
          "calculate": "'National Avg: ' + format(datum.avg_percentage, '.1f') + '%'",
          "as": "avg_label"
        }
      ],
      "mark": {
        "type": "text",
        "align": "left",
        "dx": 5,
        "dy": -5,
        "fontSize": 12,
        "color": "black"
      },
      "encoding": {
        "y": {"aggregate": "mean", "field": "percentage"},
        "text": {"field": "avg_label"}
      }
    }
  ],
  "config": {
    "axis": {"labelFontSize": 12, "titleFontSize": 14},
    "header": {"labelFontSize": 14, "titleFontSize": 16}
  }
}
